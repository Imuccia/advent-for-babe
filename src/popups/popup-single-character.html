<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=900, initial-scale=1.0">
    <title>Advent Calendar Surprise</title>
    <style>
        html, body, button, input, a, .day, .clickable, .disabled {
            cursor: url('../assets/images/cursor/Spamton_battle_static.png') 8 8, auto !important;
        }
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
        }
        .confetti-piece {
            position: absolute;
            opacity: 0.85;
            will-change: transform, opacity;
            pointer-events: none;
        }
        .confetti-star {
            width: 18px;
            height: 18px;
            background: none;
            position: absolute;
            pointer-events: none;
        }
        .confetti-star svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .confetti-sparkle {
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #fff 60%, transparent 100%);
            border-radius: 50%;
            position: absolute;
            pointer-events: none;
            opacity: 0.7;
        }
        .blurred-img.unblurred {
            filter: none;
            transition: filter 0.5s;
        }
        h2 {
            margin-top: 1.2rem;
            margin-bottom: 1.5rem;
            font-size: 2rem;
            text-align: center;
        }
        .input-row {
            display: flex;
            gap: 0.7rem;
            margin-bottom: 2.2rem;
            margin-top: 0.5rem;
            justify-content: center;
        }
        .hints-container {
            margin-top: auto;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 500px;
        }
        .hint-row {
            margin-bottom: 1.1rem;
        }
        .blurred-img {
            margin-bottom: 1.2rem;
        }
        .blurred-img {
            max-width: 90vw;
            max-height: 98vh;
            display: block;
            filter: blur(40px) brightness(0.9) contrast(0.9);
            margin: 0 auto;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            object-fit: contain;
            background: transparent;
        }
        body {
            background: #fffbe7;
            color: #c41e3a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            padding: 0 1rem;
        }
        .input-row input, .input-row button {
            font-size: 1.1rem;
            padding: 0.4em 1em;
            border-radius: 8px;
            border: none;
            background: #c41e3a;
            color: #fffbe7;
            cursor: pointer;
        }
        .hint-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .hint-row .hint-text {
            margin-left: 1em;
            color: #1a472a;
            font-size: 1.1rem;
            display: none;
        }
        .hint-row .hint-text.visible {
            display: inline;
        }
        .speaker {
            margin-left: 1em;
            font-size: 1.5rem;
            cursor: pointer;
            color: #c41e3a;
            transition: color 0.2s;
        }
        .speaker:hover {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div id="confetti" class="confetti"></div>
    <!-- Blurred image at the top -->
    <img id="popupImg" src="" alt="Blurred" class="blurred-img">

    <!-- Title text -->
    <h2 id="popupTitle"></h2>

    <!-- Text input and button -->
    <div class="input-row" id="inputRow">
        <input type="text" id="answerInput" placeholder="Type your answer...">
        <button id="sendBtn">Send</button>
    </div>
    <!-- Mark as completed for special days -->
    <div class="input-row" id="markCompletedRow" style="display:none; justify-content:center;">
        <button id="markCompletedBtn" title="Mark as completed"></button>
    </div>

    <!-- Hint #2 with speaker icon -->
    <div class="hint-row">
        <button id="hint1Btn">
            <span>Hint #1</span>
            <span style="margin-left:0.5em; font-size:1.3em; vertical-align:middle;">üó£Ô∏è</span>
        </button>
        <span class="hint-text" id="hint1Text"></span>
    </div>
    <div class="hint-row">
        <button id="audioBtn" class="audio-btn" style="display:inline-flex; align-items:center;">
            <span>Hint #2</span>
            <span class="speaker" title="Play audio" style="margin-left:0.5em; font-size:1.5em;">üîä</span>
        </button>
        <audio id="hintAudio" preload="auto"></audio>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Read query params for img, title, day, blur, hint1
            const params = new URLSearchParams(window.location.search);
            const day = params.get('day');
            let imgSrc = params.get('img');
            const title = params.get('title') || 'WHO DIS OwO';
            const blurAmount = parseInt(params.get('blur')) || 30;
            const hint1 = params.get('hint1') || '';
            const answer = params.get('answer') || '';
            // Robust image path resolution
            if (!imgSrc) {
                imgSrc = '../assets/images/0737_Shiny_Charjabug.webp';
            } else if (imgSrc.startsWith('./assets/')) {
                imgSrc = '..' + imgSrc.slice(1);
            } else if (imgSrc.startsWith('assets/')) {
                imgSrc = '../' + imgSrc;
            } else if (!imgSrc.startsWith('..') && !imgSrc.startsWith('/')) {
                imgSrc = '../assets/images/' + imgSrc;
            }
            const imgElem = document.getElementById('popupImg');
            imgElem.src = imgSrc;
            imgElem.style.filter = `blur(${blurAmount}px)`;
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('hint1Text').textContent = hint1;

            // Extract correct answer from image filename (without extension)
            const imgName = imgSrc.split('/').pop().split('.')[0].toLowerCase();
            // Focus the answer input on load
            setTimeout(function() {
                answerInput.focus();
            }, 50);
            // Setup variables
            const hint1Btn = document.getElementById('hint1Btn');
            const hint1Text = document.getElementById('hint1Text');
            const audioBtn = document.getElementById('audioBtn');
            const hintAudio = document.getElementById('hintAudio');
            // Set audio src based on answer
            if (answer) {
                // Replace spaces with underscores for file naming if needed
                const audioFile = `../assets/audio/${answer}.mp3`;
                hintAudio.src = audioFile;
                // Prime audio context for first play
                hintAudio.volume = 0;
                hintAudio.play().then(() => {
                    hintAudio.pause();
                    hintAudio.currentTime = 0;
                    hintAudio.volume = 1;
                }).catch(() => {
                    // Ignore errors if browser blocks auto-play
                    hintAudio.volume = 1;
                });
            }
            const sendBtn = document.getElementById('sendBtn');
            const answerInput = document.getElementById('answerInput');
            const blurredImg = document.querySelector('.blurred-img');
            // Show/hide input or mark-completed for special days
            const inputRow = document.getElementById('inputRow');
            const markCompletedRow = document.getElementById('markCompletedRow');
            const markCompletedBtn = document.getElementById('markCompletedBtn');
            if (!answer) {
                // No answer: show mark as completed button
                inputRow.style.display = 'none';
                markCompletedRow.style.display = 'flex';
                if (markCompletedBtn) {
                    markCompletedBtn.onclick = function() {
                        if (window.opener && day) {
                            window.opener.postMessage({ type: 'advent-day-solved', day: Number(day) }, '*');
                        }
                        window.close();
                    };
                }
            } else {
                // Normal answer mode
                inputRow.style.display = '';
                markCompletedRow.style.display = 'none';
            }
            // Play audio when Hint #2 button is clicked
            if (audioBtn && hintAudio) {
                audioBtn.addEventListener('click', function () {
                    hintAudio.pause();
                    hintAudio.currentTime = 0;
                    hintAudio.volume = 0;
                    hintAudio.play().then(() => {
                        hintAudio.pause();
                        hintAudio.currentTime = 0;
                        hintAudio.volume = 1;
                        setTimeout(() => hintAudio.play(), 100);
                    }).catch(() => {
                        hintAudio.volume = 1;
                        setTimeout(() => hintAudio.play(), 100);
                    });
                });
            }

            // Allow pressing Enter to submit answer
            answerInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !sendBtn.disabled && !answerInput.disabled) {
                    sendBtn.click();
                }
            });

            // Confetti animation
            function launchConfetti() {
                // Gold, silver, red, green
                const confettiColors = [
                    '#ffd700', // gold
                    '#fffafa', // silver (snow white)
                    '#c0c0c0', // silver
                    '#c41e3a', // red
                    '#1a472a'  // green
                ];
                const confettiContainer = document.getElementById('confetti');
                confettiContainer.innerHTML = '';
                const pieces = 60;
                const stars = 15;
                const sparkles = 30;
                // Rectangles and circles
                for (let i = 0; i < pieces; i++) {
                    const conf = document.createElement('div');
                    conf.className = 'confetti-piece';
                    const shape = Math.random() > 0.5 ? 'circle' : 'rect';
                    const color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                    const size = Math.random() * 10 + 10;
                    conf.style.width = shape === 'circle' ? `${size}px` : `${size + 4}px`;
                    conf.style.height = `${size}px`;
                    conf.style.background = color;
                    conf.style.borderRadius = shape === 'circle' ? '50%' : '3px';
                    conf.style.left = Math.random() * 100 + 'vw';
                    conf.style.top = '-20px';
                    conf.style.boxShadow = `0 0 8px 2px ${color}55`;
                    conf.style.transform = `rotate(${Math.random() * 360}deg)`;
                    confettiContainer.appendChild(conf);
                    setTimeout(() => {
                        conf.style.transition = `top 2.1s cubic-bezier(.4,1,.6,1), left 2.1s linear, transform 2.1s linear, opacity 2.1s`;
                        conf.style.top = 80 + 20 * Math.random() + 'vh';
                        conf.style.left = (parseFloat(conf.style.left) + (Math.random() - 0.5) * 30) + 'vw';
                        conf.style.transform = `rotate(${Math.random() * 720}deg)`;
                        conf.style.opacity = 0.7 + 0.3 * Math.random();
                    }, 10);
                }
                // Stars
                for (let i = 0; i < stars; i++) {
                    const star = document.createElement('div');
                    star.className = 'confetti-star';
                    star.style.left = Math.random() * 100 + 'vw';
                    star.style.top = '-20px';
                    star.style.transform = `rotate(${Math.random() * 360}deg)`;
                    star.innerHTML = `<svg viewBox="0 0 24 24"><polygon points="12,2 15,10 24,10 17,15 19,23 12,18 5,23 7,15 0,10 9,10" fill="${confettiColors[Math.floor(Math.random() * confettiColors.length)]}"/></svg>`;
                    confettiContainer.appendChild(star);
                    setTimeout(() => {
                        star.style.transition = `top 2.3s cubic-bezier(.4,1,.6,1), left 2.3s linear, transform 2.3s linear, opacity 2.3s`;
                        star.style.top = 80 + 20 * Math.random() + 'vh';
                        star.style.left = (parseFloat(star.style.left) + (Math.random() - 0.5) * 30) + 'vw';
                        star.style.transform = `rotate(${Math.random() * 720}deg)`;
                        star.style.opacity = 0.8 + 0.2 * Math.random();
                    }, 10);
                }
                // Sparkles
                for (let i = 0; i < sparkles; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'confetti-sparkle';
                    sparkle.style.left = Math.random() * 100 + 'vw';
                    sparkle.style.top = '-10px';
                    sparkle.style.opacity = 0.5 + 0.5 * Math.random();
                    confettiContainer.appendChild(sparkle);
                    setTimeout(() => {
                        sparkle.style.transition = `top 1.7s cubic-bezier(.4,1,.6,1), left 1.7s linear, opacity 1.7s`;
                        sparkle.style.top = 80 + 20 * Math.random() + 'vh';
                        sparkle.style.left = (parseFloat(sparkle.style.left) + (Math.random() - 0.5) * 30) + 'vw';
                        sparkle.style.opacity = 0;
                    }, 10);
                }
                setTimeout(() => { confettiContainer.innerHTML = ''; }, 2500);
            }

            // Hint #1 button reveals text
            hint1Btn.onclick = function() {
                hint1Text.classList.add('visible');
            };
            // Hint #2 button plays audio
            audioBtn.onclick = function() {
                hintAudio.play();
            };
            // Send button checks answer
            sendBtn.onclick = function() {
                const val = answerInput.value.trim().toLowerCase();
                if (val.includes(imgName)) {
                    blurredImg.classList.add('unblurred');
                    // Actually remove the blur filter
                    blurredImg.style.filter = 'none';
                    answerInput.disabled = true;
                    sendBtn.disabled = true;
                    launchConfetti();
                    if (window.opener && day) {
                        window.opener.postMessage({ type: 'advent-day-solved', day: Number(day) }, '*');
                    }
                } else {
                    answerInput.value = '';
                    answerInput.placeholder = 'Try again!';
                }
            };
        });
    </script>
</body>
</html>